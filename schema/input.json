{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "TransactionInput",
  "description": "Input root for transaction JSON",
  "type": "object",
  "required": [
    "transactions"
  ],
  "properties": {
    "transactions": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Transaction"
      }
    }
  },
  "definitions": {
    "Asset": {
      "type": "object",
      "required": [
        "quantity",
        "symbol"
      ],
      "properties": {
        "asset_class": {
          "default": "Crypto",
          "allOf": [
            {
              "$ref": "#/definitions/AssetClass"
            }
          ]
        },
        "quantity": {
          "type": "number",
          "format": "double"
        },
        "symbol": {
          "type": "string"
        }
      }
    },
    "AssetClass": {
      "description": "Asset class for tax treatment",
      "type": "string",
      "enum": [
        "Crypto",
        "Stock"
      ]
    },
    "Fee": {
      "type": "object",
      "required": [
        "amount",
        "asset"
      ],
      "properties": {
        "amount": {
          "type": "number",
          "format": "double"
        },
        "asset": {
          "type": "string"
        },
        "price": {
          "default": null,
          "anyOf": [
            {
              "$ref": "#/definitions/Price"
            },
            {
              "type": "null"
            }
          ]
        }
      }
    },
    "Price": {
      "description": "Price for an asset - either direct GBP or foreign currency with FX conversion\n\nFor direct GBP prices: value_gbp = quantity * rate For FX prices: value_gbp = quantity * rate * fx_rate",
      "type": "object",
      "required": [
        "base",
        "rate"
      ],
      "properties": {
        "base": {
          "description": "The asset this price refers to (e.g., \"BTC\", \"ETH\")",
          "type": "string"
        },
        "fx_rate": {
          "description": "FX rate to convert quote currency to GBP - requires quote",
          "default": null,
          "type": [
            "number",
            "null"
          ],
          "format": "double"
        },
        "quote": {
          "description": "Foreign currency quote (e.g., \"USD\") - requires fx_rate",
          "default": null,
          "type": [
            "string",
            "null"
          ]
        },
        "rate": {
          "description": "Price per unit (in GBP, or in quote currency if FX fields present)",
          "type": "number",
          "format": "double"
        },
        "source": {
          "description": "Optional source of price data",
          "default": null,
          "type": [
            "string",
            "null"
          ]
        }
      }
    },
    "Transaction": {
      "description": "Transaction record with common fields + type-specific data",
      "type": "object",
      "oneOf": [
        {
          "description": "Trade one asset for another (includes fiat and crypto-to-crypto)",
          "type": "object",
          "required": [
            "bought",
            "sold",
            "type"
          ],
          "properties": {
            "bought": {
              "$ref": "#/definitions/Asset"
            },
            "sold": {
              "$ref": "#/definitions/Asset"
            },
            "type": {
              "type": "string",
              "enum": [
                "Trade"
              ]
            }
          }
        },
        {
          "description": "Deposit - assets received INTO an account",
          "type": "object",
          "required": [
            "asset",
            "type"
          ],
          "properties": {
            "asset": {
              "$ref": "#/definitions/Asset"
            },
            "linked_withdrawal": {
              "default": null,
              "type": [
                "string",
                "null"
              ]
            },
            "type": {
              "type": "string",
              "enum": [
                "Deposit"
              ]
            }
          }
        },
        {
          "description": "Withdrawal - assets sent FROM an account",
          "type": "object",
          "required": [
            "asset",
            "type"
          ],
          "properties": {
            "asset": {
              "$ref": "#/definitions/Asset"
            },
            "linked_deposit": {
              "default": null,
              "type": [
                "string",
                "null"
              ]
            },
            "type": {
              "type": "string",
              "enum": [
                "Withdrawal"
              ]
            }
          }
        },
        {
          "description": "Staking reward (income + acquisition)",
          "type": "object",
          "required": [
            "asset",
            "type"
          ],
          "properties": {
            "asset": {
              "$ref": "#/definitions/Asset"
            },
            "type": {
              "type": "string",
              "enum": [
                "StakingReward"
              ]
            }
          }
        }
      ],
      "required": [
        "account",
        "datetime",
        "id"
      ],
      "properties": {
        "account": {
          "description": "Account/wallet where this happened (e.g., \"kraken\", \"ledger\")",
          "type": "string"
        },
        "datetime": {
          "description": "When the transaction occurred (RFC3339 with offset; date-only assumes UTC)",
          "type": "string"
        },
        "description": {
          "description": "Optional description",
          "default": null,
          "type": [
            "string",
            "null"
          ]
        },
        "fee": {
          "description": "Optional fee for this transaction",
          "default": null,
          "anyOf": [
            {
              "$ref": "#/definitions/Fee"
            },
            {
              "type": "null"
            }
          ]
        },
        "id": {
          "description": "Unique identifier for this transaction",
          "type": "string"
        },
        "price": {
          "description": "Optional price for valuation (required for crypto-to-crypto trades and staking rewards)",
          "default": null,
          "anyOf": [
            {
              "$ref": "#/definitions/Price"
            },
            {
              "type": "null"
            }
          ]
        }
      }
    }
  }
}
