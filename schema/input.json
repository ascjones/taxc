{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "TransactionInput",
  "description": "Input root for transaction JSON",
  "type": "object",
  "properties": {
    "transactions": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Transaction"
      }
    }
  },
  "required": [
    "transactions"
  ],
  "$defs": {
    "Asset": {
      "type": "object",
      "properties": {
        "asset_class": {
          "$ref": "#/$defs/AssetClass",
          "default": "Crypto"
        },
        "quantity": {
          "type": "number",
          "format": "double"
        },
        "symbol": {
          "type": "string"
        }
      },
      "required": [
        "symbol",
        "quantity"
      ]
    },
    "AssetClass": {
      "description": "Asset class for tax treatment",
      "type": "string",
      "enum": [
        "Crypto",
        "Stock"
      ]
    },
    "Fee": {
      "type": "object",
      "properties": {
        "amount": {
          "type": "number",
          "format": "double"
        },
        "asset": {
          "type": "string"
        },
        "price": {
          "anyOf": [
            {
              "$ref": "#/$defs/Price"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        }
      },
      "required": [
        "asset",
        "amount"
      ]
    },
    "Price": {
      "description": "Price for an asset - either direct GBP or foreign currency with FX conversion\n\nFor direct GBP prices: value_gbp = quantity * rate\nFor FX prices: value_gbp = quantity * rate * fx_rate",
      "type": "object",
      "properties": {
        "base": {
          "description": "The asset this price refers to (e.g., \"BTC\", \"ETH\")",
          "type": "string"
        },
        "fx_rate": {
          "description": "FX rate to convert quote currency to GBP - requires quote",
          "type": [
            "number",
            "null"
          ],
          "format": "double",
          "default": null
        },
        "quote": {
          "description": "Foreign currency quote (e.g., \"USD\") - requires fx_rate",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "rate": {
          "description": "Price per unit (in GBP, or in quote currency if FX fields present)",
          "type": "number",
          "format": "double"
        },
        "source": {
          "description": "Optional source of price data",
          "type": [
            "string",
            "null"
          ],
          "default": null
        }
      },
      "required": [
        "base",
        "rate"
      ]
    },
    "Tag": {
      "description": "Classification tag for a taxable event",
      "oneOf": [
        {
          "type": "string",
          "enum": [
            "Trade",
            "StakingReward",
            "Salary",
            "OtherIncome",
            "Airdrop",
            "AirdropIncome",
            "Gift"
          ]
        },
        {
          "description": "Unclassified event - needs review",
          "type": "string",
          "const": "Unclassified"
        }
      ]
    },
    "Transaction": {
      "description": "Transaction record with common fields + type-specific data",
      "type": "object",
      "properties": {
        "account": {
          "description": "Account/wallet where this happened (e.g., \"kraken\", \"ledger\")",
          "type": "string"
        },
        "datetime": {
          "description": "When the transaction occurred (RFC3339 with offset; date-only assumes UTC)",
          "type": "string"
        },
        "description": {
          "description": "Optional description",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "fee": {
          "description": "Optional fee for this transaction",
          "anyOf": [
            {
              "$ref": "#/$defs/Fee"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "id": {
          "description": "Unique identifier for this transaction",
          "type": "string"
        },
        "price": {
          "description": "Optional price for valuation",
          "anyOf": [
            {
              "$ref": "#/$defs/Price"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "tag": {
          "description": "Optional transaction tag used for classification",
          "$ref": "#/$defs/Tag",
          "default": "Unclassified"
        }
      },
      "oneOf": [
        {
          "description": "Trade one asset for another (includes fiat and crypto-to-crypto)",
          "type": "object",
          "properties": {
            "bought": {
              "$ref": "#/$defs/Asset"
            },
            "sold": {
              "$ref": "#/$defs/Asset"
            },
            "type": {
              "type": "string",
              "const": "Trade"
            }
          },
          "required": [
            "type",
            "sold",
            "bought"
          ]
        },
        {
          "description": "Deposit - assets received INTO an account",
          "type": "object",
          "properties": {
            "asset": {
              "$ref": "#/$defs/Asset"
            },
            "linked_withdrawal": {
              "type": [
                "string",
                "null"
              ],
              "default": null
            },
            "type": {
              "type": "string",
              "const": "Deposit"
            }
          },
          "required": [
            "type",
            "asset"
          ]
        },
        {
          "description": "Withdrawal - assets sent FROM an account",
          "type": "object",
          "properties": {
            "asset": {
              "$ref": "#/$defs/Asset"
            },
            "linked_deposit": {
              "type": [
                "string",
                "null"
              ],
              "default": null
            },
            "type": {
              "type": "string",
              "const": "Withdrawal"
            }
          },
          "required": [
            "type",
            "asset"
          ]
        }
      ],
      "required": [
        "id",
        "datetime",
        "account"
      ]
    }
  }
}
